import React, { useState, useEffect } from 'react';
import { useAppContext } from '../../contexts/AppContext';
import { useLanguage } from '../../contexts/LanguageContext';
import apiService from '../../services/api';

const BookingsScreen = ({ onOpenChat, onNavigateToMessages }) => {
  const { user: currentUser } = useAppContext();
  const { t } = useLanguage();
  const [activeTab, setActiveTab] = useState('outgoing'); // 'outgoing' or 'incoming'
  const [deals, setDeals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [expandedDealId, setExpandedDealId] = useState(null);
  const [dealToDelete, setDealToDelete] = useState(null);

  useEffect(() => {
    fetchDeals();
  }, [activeTab, currentUser]);

  const fetchDeals = async () => {
    if (!currentUser || !currentUser._id) {
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');

    try {
      const type = activeTab; // 'outgoing' or 'incoming'
      const response = await apiService.getDeals({ profileId: currentUser._id, type });
      setDeals(response.deals || []);
    } catch (err) {
      console.error('Error fetching deals:', err);
      setError(err.message || 'Failed to load bookings');
    } finally {
      setLoading(false);
    }
  };

  const handleAcceptDeal = async (dealId) => {
    try {
      await apiService.acceptDeal(dealId, currentUser._id);
      // Refresh deals after accepting
      fetchDeals();
    } catch (err) {
      console.error('Error accepting deal:', err);
      alert(err.message || 'Failed to accept offer');
    }
  };

  const handleDeclineDeal = async (dealId) => {
    try {
      await apiService.declineDeal(dealId, currentUser._id);
      // Refresh deals after declining
      fetchDeals();
    } catch (err) {
      console.error('Error declining deal:', err);
      alert(err.message || 'Failed to decline offer');
    }
  };

  const handleDeleteDeal = async () => {
    if (!dealToDelete) return;

    try {
      await apiService.deleteDeal(dealToDelete, currentUser._id);
      setDealToDelete(null);
      // Refresh deals after deleting
      fetchDeals();
    } catch (err) {
      console.error('Error deleting deal:', err);
      alert(err.message || 'Failed to delete offer');
      setDealToDelete(null);
    }
  };

  const toggleDealExpanded = (dealId) => {
    setExpandedDealId(expandedDealId === dealId ? null : dealId);
  };

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  };

  const getStatusBadgeClass = (status) => {
    switch (status) {
      case 'PENDING':
        return 'status-badge status-pending';
      case 'NEGOTIATING':
        return 'status-badge status-negotiating';
      case 'ACCEPTED':
        return 'status-badge status-accepted';
      case 'DECLINED':
        return 'status-badge status-declined';
      case 'COMPLETED':
        return 'status-badge status-completed';
      default:
        return 'status-badge';
    }
  };

  const renderDealCard = (deal) => {
    const isOutgoing = deal.initiator._id === currentUser._id;
    const otherParty = isOutgoing
      ? (deal.venue._id === currentUser._id ? deal.artist : deal.venue)
      : deal.initiator;

    const isExpanded = expandedDealId === deal._id;

    return (
      <div key={deal._id} className={`booking-card ${isExpanded ? 'expanded' : ''}`}>
        <div className="booking-header" onClick={() => toggleDealExpanded(deal._id)}>
          <div className="booking-party">
            <div className="party-avatar">
              {otherParty.avatar ? (
                <img src={otherParty.avatar} alt={otherParty.name} />
              ) : (
                otherParty.name.charAt(0).toUpperCase()
              )}
            </div>
            <div className="party-info">
              <h3>{otherParty.name}</h3>
              <p className="party-role">{otherParty.role} â€¢ {otherParty.location}</p>
            </div>
          </div>
          <div className="booking-header-actions">
            <span className={getStatusBadgeClass(deal.status)}>
              {deal.status}
            </span>
            {/* Delete button - only for initiator and only for PENDING offers */}
            {isOutgoing && deal.status === 'PENDING' && (
              <button
                className="btn-delete-offer"
                onClick={(e) => {
                  e.stopPropagation();
                  setDealToDelete(deal._id);
                }}
                title="Delete offer"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            )}
            <button className="btn-expand-arrow">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.3s' }}>
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
          </div>
        </div>

        {/* Compact summary */}
        <div className="booking-summary">
          <div className="summary-item">
            <span className="summary-label">Event:</span>
            <span className="summary-value">{deal.eventName}</span>
          </div>
          <div className="summary-item">
            <span className="summary-label">Date:</span>
            <span className="summary-value">{formatDate(deal.date)}</span>
          </div>
          <div className="summary-item">
            <span className="summary-label">Fee:</span>
            <span className="summary-value booking-fee">
              {deal.currentFee} {deal.currency}
            </span>
          </div>
        </div>

        {/* Expanded details */}
        {isExpanded && (
          <div className="booking-details">
          <div className="booking-detail-row">
            <span className="detail-label">Event:</span>
            <span className="detail-value">{deal.eventName}</span>
          </div>
          <div className="booking-detail-row">
            <span className="detail-label">Venue:</span>
            <span className="detail-value">{deal.venueName}</span>
          </div>
          <div className="booking-detail-row">
            <span className="detail-label">Date:</span>
            <span className="detail-value">{formatDate(deal.date)}</span>
          </div>
          {deal.startTime && deal.endTime && (
            <div className="booking-detail-row">
              <span className="detail-label">Time:</span>
              <span className="detail-value">{deal.startTime} - {deal.endTime}</span>
            </div>
          )}
          <div className="booking-detail-row">
            <span className="detail-label">Fee:</span>
            <span className="detail-value booking-fee">
              {deal.currentFee} {deal.currency}
            </span>
          </div>
          {deal.performanceType && (
            <div className="booking-detail-row">
              <span className="detail-label">Type:</span>
              <span className="detail-value">{deal.performanceType}</span>
            </div>
          )}
          {deal.setDuration && (
            <div className="booking-detail-row">
              <span className="detail-label">Duration:</span>
              <span className="detail-value">{deal.setDuration} minutes</span>
            </div>
          )}
          {deal.notes && (
            <div className="booking-detail-row full-width">
              <span className="detail-label">Notes:</span>
              <span className="detail-value">{deal.notes}</span>
            </div>
          )}
        </div>

        {/* Action buttons for incoming offers */}
        {!isOutgoing && (deal.status === 'PENDING' || deal.status === 'NEGOTIATING') && (
          <div className="booking-actions">
            <button
              className="btn btn-outline btn-decline"
              onClick={() => handleDeclineDeal(deal._id)}
            >
              Decline
            </button>
            <button
              className="btn btn-primary btn-accept"
              onClick={() => handleAcceptDeal(deal._id)}
            >
              Accept Offer
            </button>
          </div>
        )}

        {/* Show chat button */}
        <button
          className="btn btn-outline btn-chat"
          onClick={(e) => {
            e.stopPropagation();
            onOpenChat && onOpenChat(otherParty);
          }}
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          Message
        </button>
        )}
      </div>
    );
  };

  return (
    <div className="bookings-screen">
      <div className="bookings-header">
        <h1>Bookings</h1>
        <p className="bookings-subtitle">Manage your booking offers</p>
      </div>

      <div className="bookings-tabs">
        <button
          className={`bookings-tab ${activeTab === 'outgoing' ? 'active' : ''}`}
          onClick={() => setActiveTab('outgoing')}
        >
          Sent Offers
          {deals.length > 0 && activeTab === 'outgoing' && (
            <span className="tab-badge">{deals.length}</span>
          )}
        </button>
        <button
          className={`bookings-tab ${activeTab === 'incoming' ? 'active' : ''}`}
          onClick={() => setActiveTab('incoming')}
        >
          Received Offers
          {deals.length > 0 && activeTab === 'incoming' && (
            <span className="tab-badge">{deals.length}</span>
          )}
        </button>
      </div>

      <div className="bookings-content">
        {loading ? (
          <div className="bookings-loading">
            <div className="spinner"></div>
            <p>Loading bookings...</p>
          </div>
        ) : error ? (
          <div className="bookings-error">
            <p>{error}</p>
            <button className="btn btn-outline" onClick={fetchDeals}>
              Try Again
            </button>
          </div>
        ) : deals.length === 0 ? (
          <div className="bookings-empty">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h3>No {activeTab === 'outgoing' ? 'sent' : 'received'} offers yet</h3>
            <p>
              {activeTab === 'outgoing'
                ? 'Start conversations and make offers to book gigs!'
                : 'When someone sends you a booking offer, it will appear here.'
              }
            </p>
          </div>
        ) : (
          <div className="bookings-list">
            {deals.map(deal => renderDealCard(deal))}
          </div>
        )}
      </div>

      {/* Custom Delete Confirmation Modal */}
      {dealToDelete && (
        <div className="delete-modal-overlay" onClick={() => setDealToDelete(null)}>
          <div className="delete-modal" onClick={(e) => e.stopPropagation()}>
            <div className="delete-modal-header">
              <h3>Delete Offer</h3>
            </div>
            <div className="delete-modal-content">
              <p>Are you sure you want to delete this offer?</p>
              <p className="delete-modal-warning">This action cannot be undone.</p>
            </div>
            <div className="delete-modal-actions">
              <button
                className="btn btn-outline"
                onClick={() => setDealToDelete(null)}
              >
                Cancel
              </button>
              <button
                className="btn btn-danger"
                onClick={handleDeleteDeal}
              >
                Delete Offer
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default BookingsScreen;
